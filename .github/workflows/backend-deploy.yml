name: Backend Deploy
on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: "Log level"
        required: true
        default: "warning"
      tags:
        description: "Test scenario tags"

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@master
      - name: Build Cloud Functions
        run: cd backend/functions && npm ci
      - name: Make envfile
        uses: SpicyPizza/create-envfile@v2.0.2
        with:
          envkey_PG_HOST: ${{ secrets.PG_HOST }}
          envkey_PG_PORT: ${{ secrets.PG_PORT }}
          envkey_PG_USER: ${{ secrets.PG_USER }}
          envkey_PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
          envkey_PG_DATABASE: ${{ secrets.PG_DATABASE }}
          envkey_GITHUB_TOKEN: ${{ secrets.GH_GITHUB_TOKEN }}
          envkey_GITHUB_REPOSITORY: giraffeql-boilerplate
          envkey_GITHUB_ORGANIZATION:
          envkey_SERVE_IMAGE_BUCKET: giraffeql-boilerplate.appspot.com
          envkey_SERVE_IMAGE_SOURCE_PATH: source
          envkey_SERVE_IMAGE_CACHE_PATH: cache
          envkey_SERVE_IMAGE_TEMP_PATH: temp
          envkey_SERVE_IMAGE_CDN_URL: https://cdn.giraffeql.com
          envkey_STRIPE_SITE_URL: https://boilerplate.giraffeql.com
          envkey_BASE_ORIGINS: http://localhost:3000,https://boilerplate.giraffeql.com
          envkey_BASE_TIMEOUT_SECONDS: 60
          envkey_BASE_VERSION: ${{ github.sha }}
          directory: backend/functions
          file_name: .env
      - name: Create SA key
        run: echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > $HOME/gcloud.json
      - name: Deploy Cloud Functions
        run: export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud.json && cd backend/functions && npx firebase-tools deploy --only functions --json
